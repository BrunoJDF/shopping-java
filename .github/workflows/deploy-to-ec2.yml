name: Deploy to EC2

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
    
    - name: Run tests (unit tests only)
      run: |
        chmod +x ./mvnw
        ./mvnw test -Pci -Dspring.profiles.active=test

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
    
    - name: Build application
      run: |
        chmod +x ./mvnw
        ./mvnw clean package -DskipTests
    
    - name: Build Docker image
      run: |
        docker build -t shopping-java:${{ github.sha }} .
        docker tag shopping-java:${{ github.sha }} shopping-java:latest
        docker save shopping-java:latest | gzip > shopping-java.tar.gz
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-2
    
    - name: Upload Docker image to S3
      run: |
        # Crear bucket temporal si no existe
        aws s3 mb s3://shopping-java-deploy-${{ github.run_id }} || true
        
        # Subir archivos
        aws s3 cp shopping-java.tar.gz s3://shopping-java-deploy-${{ github.run_id }}/
        aws s3 cp scripts/setup-ec2.sh s3://shopping-java-deploy-${{ github.run_id }}/
        
        echo "Files uploaded to S3 successfully"
    
    - name: Deploy to EC2 via AWS CLI
      run: |
        # Script de despliegue
        DEPLOY_SCRIPT=$(cat << 'EOF'
        #!/bin/bash
        set -e
        
        echo "ðŸš€ Starting deployment..."
        
        # Instalar AWS CLI si no estÃ¡ disponible
        if ! command -v aws &> /dev/null; then
          echo "ðŸ“¦ Installing AWS CLI..."
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip awscliv2.zip
          sudo ./aws/install
          rm -rf awscliv2.zip aws/
        fi
        
        # Descargar archivos desde S3
        aws s3 cp s3://shopping-java-deploy-${{ github.run_id }}/shopping-java.tar.gz ./
        aws s3 cp s3://shopping-java-deploy-${{ github.run_id }}/setup-ec2.sh ./
        
        # Configurar variables de entorno
        export DB_HOST="${{ secrets.DB_HOST }}"
        export DB_PORT="${{ secrets.DB_PORT }}"
        export DB_NAME="${{ secrets.DB_NAME }}"
        export DB_USERNAME="${{ secrets.DB_USERNAME }}"
        export DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
        export SCHEMA_CONTEXT="${{ secrets.SCHEMA_CONTEXT }}"
        export PROFILE_ACTIVE="prod"
        
        # Ejecutar setup si es necesario
        chmod +x setup-ec2.sh
        ./setup-ec2.sh || echo "Setup already done"
        
        # Cargar nueva imagen Docker
        docker load < shopping-java.tar.gz
        
        # Detener contenedor anterior si existe
        docker stop shopping-java 2>/dev/null || true
        docker rm shopping-java 2>/dev/null || true
        
        # Ejecutar nueva versiÃ³n
        docker run -d \
          --name shopping-java \
          --restart unless-stopped \
          -p 80:8080 \
          -e PROFILE_ACTIVE=prod \
          -e DB_HOST="${{ secrets.DB_HOST }}" \
          -e DB_PORT="${{ secrets.DB_PORT }}" \
          -e DB_NAME="${{ secrets.DB_NAME }}" \
          -e DB_USERNAME="${{ secrets.DB_USERNAME }}" \
          -e DB_PASSWORD="${{ secrets.DB_PASSWORD }}" \
          -e SCHEMA_CONTEXT="${{ secrets.SCHEMA_CONTEXT }}" \
          -v /var/log/shopping-java:/var/log/shopping-java \
          shopping-java:latest
        
        # Limpiar archivos
        rm -f shopping-java.tar.gz setup-ec2.sh
        
        # Verificar que la aplicaciÃ³n estÃ© corriendo
        echo "â³ Waiting for application to start..."
        sleep 30
        
        if curl -f http://localhost/api/actuator/health; then
          echo "âœ… Application deployed successfully!"
        else
          echo "âŒ Application health check failed"
          docker logs shopping-java --tail 50
          exit 1
        fi
        EOF
        )
        
        # Crear el script en el servidor
        echo "$DEPLOY_SCRIPT" > deploy.sh
        
        # Subir script de despliegue
        aws s3 cp deploy.sh s3://shopping-java-deploy-${{ github.run_id }}/
        
        # Crear archivo temporal de clave SSH
        echo "${{ secrets.EC2_SSH_KEY }}" > /tmp/ssh_key
        chmod 600 /tmp/ssh_key
        
        # Ejecutar despliegue via SSH usando credenciales AWS para descargar
        ssh -i /tmp/ssh_key \
          -o StrictHostKeyChecking=no \
          -o ConnectTimeout=30 \
          ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
          "
          # Configurar AWS CLI en EC2 con credenciales temporales
          export AWS_ACCESS_KEY_ID='${{ secrets.AWS_ACCESS_KEY_ID }}'
          export AWS_SECRET_ACCESS_KEY='${{ secrets.AWS_SECRET_ACCESS_KEY }}'
          export AWS_DEFAULT_REGION='us-east-2'
          
          # Descargar y ejecutar script de despliegue
          aws s3 cp s3://shopping-java-deploy-${{ github.run_id }}/deploy.sh ./
          chmod +x deploy.sh
          ./deploy.sh
          "
        
        # Limpiar archivo de clave SSH
        rm -f /tmp/ssh_key
        
        # Limpiar bucket temporal
        aws s3 rm s3://shopping-java-deploy-${{ github.run_id }}/ --recursive
        aws s3 rb s3://shopping-java-deploy-${{ github.run_id }}/
        script: |
          # Configurar variables de entorno
          export DB_HOST="${{ secrets.DB_HOST }}"
          export DB_PORT="${{ secrets.DB_PORT }}"
          export DB_NAME="${{ secrets.DB_NAME }}"
          export DB_USERNAME="${{ secrets.DB_USERNAME }}"
          export DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
          export SCHEMA_CONTEXT="${{ secrets.SCHEMA_CONTEXT }}"
          export PROFILE_ACTIVE="prod"
          
          # Hacer ejecutable el script
          chmod +x setup-ec2.sh
          
          # Ejecutar script de configuraciÃ³n
          ./setup-ec2.sh
          
          # Cargar nueva imagen Docker
          docker load < shopping-java.tar.gz
          
          # Detener contenedor anterior si existe
          docker stop shopping-java || true
          docker rm shopping-java || true
          
          # Ejecutar nueva versiÃ³n
          docker run -d \
            --name shopping-java \
            --restart unless-stopped \
            -p 80:8080 \
            -e PROFILE_ACTIVE=prod \
            -e DB_HOST="${{ secrets.DB_HOST }}" \
            -e DB_PORT="${{ secrets.DB_PORT }}" \
            -e DB_NAME="${{ secrets.DB_NAME }}" \
            -e DB_USERNAME="${{ secrets.DB_USERNAME }}" \
            -e DB_PASSWORD="${{ secrets.DB_PASSWORD }}" \
            -e SCHEMA_CONTEXT="${{ secrets.SCHEMA_CONTEXT }}" \
            -v /var/log/shopping-java:/var/log/shopping-java \
            shopping-java:latest
          
          # Limpiar archivos temporales
          rm -f shopping-java.tar.gz
          
          # Verificar que la aplicaciÃ³n estÃ© corriendo
          sleep 30
          curl -f http://localhost/api/actuator/health || exit 1
