name: Deploy to EC2

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
    
    - name: Run tests (unit tests only)
      run: |
        chmod +x ./mvnw
        ./mvnw test -Pci -Dspring.profiles.active=test

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
    
    - name: Build application
      run: |
        chmod +x ./mvnw
        ./mvnw clean package -DskipTests
    
    - name: Build Docker image
      run: |
        docker build -t shopping-java:${{ github.sha }} .
        docker tag shopping-java:${{ github.sha }} shopping-java:latest
        docker save shopping-java:latest | gzip > shopping-java.tar.gz
    
    - name: Copy files to EC2
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        source: "shopping-java.tar.gz,scripts/setup-ec2.sh"
        target: "/home/${{ secrets.EC2_USER }}"
    
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          # Configurar variables de entorno
          export DB_HOST="${{ secrets.DB_HOST }}"
          export DB_PORT="${{ secrets.DB_PORT }}"
          export DB_NAME="${{ secrets.DB_NAME }}"
          export DB_USERNAME="${{ secrets.DB_USERNAME }}"
          export DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
          export SCHEMA_CONTEXT="${{ secrets.SCHEMA_CONTEXT }}"
          export PROFILE_ACTIVE="prod"
          
          # Hacer ejecutable el script
          chmod +x setup-ec2.sh
          
          # Ejecutar script de configuración
          ./setup-ec2.sh
          
          # Cargar nueva imagen Docker
          docker load < shopping-java.tar.gz
          
          # Detener contenedor anterior si existe
          docker stop shopping-java || true
          docker rm shopping-java || true
          
          # Ejecutar nueva versión
          docker run -d \
            --name shopping-java \
            --restart unless-stopped \
            -p 80:8080 \
            -e PROFILE_ACTIVE=prod \
            -e DB_HOST="${{ secrets.DB_HOST }}" \
            -e DB_PORT="${{ secrets.DB_PORT }}" \
            -e DB_NAME="${{ secrets.DB_NAME }}" \
            -e DB_USERNAME="${{ secrets.DB_USERNAME }}" \
            -e DB_PASSWORD="${{ secrets.DB_PASSWORD }}" \
            -e SCHEMA_CONTEXT="${{ secrets.SCHEMA_CONTEXT }}" \
            -v /var/log/shopping-java:/var/log/shopping-java \
            shopping-java:latest
          
          # Limpiar archivos temporales
          rm -f shopping-java.tar.gz
          
          # Verificar que la aplicación esté corriendo
          sleep 30
          curl -f http://localhost/api/actuator/health || exit 1
